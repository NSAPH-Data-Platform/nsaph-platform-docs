<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NSAPH Data Platform &mdash; NSAPH Data Platform 0.0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/sphinx_paramlinks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data Modelling for NSAPH Data Platform" href="doc/Datamodels.html" />
    <link rel="prev" title="NSAPH Core Data Platform" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> NSAPH Data Platform
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">NSAPH Data Platform</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tool-examples">Tool Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#project-structure">Project Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#software-sources">Software Sources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-packages">Python packages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nsaph-package">NSAPH Package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#yaml-files">YAML files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resources">Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="doc/Datamodels.html">Data Modelling for NSAPH Data Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="doc/UserRequests.html">Preliminary Considerations for Handling User Requests</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">NSAPH Data Platform</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>NSAPH Data Platform</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nsaph-data-platform">
<h1>NSAPH Data Platform<a class="headerlink" href="#nsaph-data-platform" title="Permalink to this headline"></a></h1>
<!-- toc --><ul class="simple">
<li><p><a class="reference external" href="#overview">Overview</a></p></li>
<li><p><a class="reference external" href="#tool-examples">Tool Examples</a></p></li>
<li><p><a class="reference external" href="#project-structure">Project Structure</a></p>
<ul>
<li><p><a class="reference external" href="#software-sources">Software Sources</a></p></li>
<li><p><a class="reference external" href="#python-packages">Python packages</a></p>
<ul>
<li><p><a class="reference external" href="#nsaph-package">NSAPH Package</a></p>
<ul>
<li><p><a class="reference external" href="#nsaphdata_model">nsaph.data_model</a></p></li>
<li><p><a class="reference external" href="#database-connection-wrapper">Database Connection Wrapper</a></p></li>
<li><p><a class="reference external" href="#nsaphloader">nsaph.loader</a></p></li>
<li><p><a class="reference external" href="#nsaphrequests">nsaph.requests</a></p></li>
<li><p><a class="reference external" href="#nsaphutil">nsaph.util</a></p></li>
<li><p><a class="reference external" href="#nsaphtools">nsaph.tools</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="#yaml-files">YAML files</a></p></li>
<li><p><a class="reference external" href="#resources">Resources</a></p></li>
</ul>
</li>
</ul>
<!-- tocstop --><section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>The data platform provides generic infrastructure for NSAPH Data Platform
It depends on nsaph_util package, but it augments it
with APIs and command line utilities dependent on the infrastructure
and the environment. For instance, its components assume presence of PostgreSQL
DBMS (version 13 or later) and CWL runtime environment.</p>
<p>The package is under intensive development, therefore its
development branches contain some obsolete modules and utilities.
The project structure can also be in flux.</p>
</section>
<section id="tool-examples">
<h2>Tool Examples<a class="headerlink" href="#tool-examples" title="Permalink to this headline"></a></h2>
<p>Examples of tools included in this package are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="doc/Datamodels.html"><span class="doc">Universal Data Loader</span></a></p></li>
<li><p>A <a class="reference external" href="doc/members/index.html">utility to monitor progress of long-running database</a>
processes like indexing.</p></li>
<li><p>A <a class="reference external" href="doc/members/analyze.html">utility to infer database schema and generate DDL</a>
from a CSV file</p></li>
<li><p>A <a class="reference external" href="doc/members/link_gis.html">utility to link a table to GIS</a>
from a CSV file</p></li>
<li><p>A <a class="reference external" href="#database-connection-wrapper">wrapper around database connection to PostgreSQL</a></p></li>
<li><p>A <a class="reference external" href="doc/members/pg_json_dump.html">utility to import/export JSONLines</a>
files into/from PostgreSQL</p></li>
<li><p>An <a class="reference external" href="doc/members/executors.html">Executor with a bounded queue</a></p></li>
</ul>
</section>
<section id="project-structure">
<h2>Project Structure<a class="headerlink" href="#project-structure" title="Permalink to this headline"></a></h2>
<p><strong>The package is under intensive development, the
project structure is in flux</strong></p>
<p>Top level directories are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">doc</span>
<span class="o">-</span> <span class="n">resources</span>
<span class="o">-</span> <span class="n">src</span>
</pre></div>
</div>
<p>Doc directory contains documentation.</p>
<p>Resource directory contains resources that must be loaded in
the data platform for its normal functioning. For example,
they contain mappings between US states, counties, fips and zip codes.
See details in <a class="reference external" href="#Resources">Resources</a> section.</p>
<p>Src directory contains software source code.
See details in <a class="reference external" href="#software-sources">Software Sources</a> section.</p>
<section id="software-sources">
<h3>Software Sources<a class="headerlink" href="#software-sources" title="Permalink to this headline"></a></h3>
<p>The directories under sources are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">airflow</span>
<span class="o">-</span> <span class="n">commonwl</span>
<span class="o">-</span> <span class="n">html</span>
<span class="o">-</span> <span class="n">plpgsql</span>
<span class="o">-</span> <span class="n">python</span>
<span class="o">-</span> <span class="n">r</span>
<span class="o">-</span> <span class="n">superset</span>
<span class="o">-</span> <span class="n">yml</span>
</pre></div>
</div>
<p>They are described in more details in the corresponding sections.
Here is a brief overview:</p>
<ul class="simple">
<li><p><em><strong>airflow</strong></em> contains code and configuration for Airflow.
Most of the content is deprecated as it is now transferred
to the deployment package or the specific pipelines. However,
this directory is intended to contain Airflow plugins that are
generic for all NSAPH pipelines</p></li>
<li><p><strong><em>commonwl</em></strong> contains reusable workflows, packaged as tools
that can and should be used by
all NSAPH pipelines. Examples of such tools
are: introspection of CSV files, indexing tables, linking
tables with GIS information for easy mapping, creation of a
Superset datasource.</p></li>
<li><p><strong><em>html</em></strong> is a deprecated directory for HTML documents</p></li>
<li><p><strong><em>plpgsql</em></strong> contains PostgreSQL procedures and functions
implemented in PL/pgSQL language</p></li>
<li><p><strong><em>python</em></strong> contains Python code. See <a class="reference external" href="#python-packages">more details</a>.</p></li>
<li><p><strong><em>r</em></strong> contains R utilities. Probably will be deprecated</p></li>
<li><p><strong><em>superset</em></strong> contains definitions of reusable Superset
datasets and dashboards</p></li>
<li><p><strong><em>yml</em></strong> contains various YAML files used by the platform.</p></li>
</ul>
</section>
<section id="python-packages">
<h3>Python packages<a class="headerlink" href="#python-packages" title="Permalink to this headline"></a></h3>
<section id="nsaph-package">
<h4>NSAPH Package<a class="headerlink" href="#nsaph-package" title="Permalink to this headline"></a></h4>
<p>This is the main package containing the majority of the code.</p>
<section id="nsaph-data-model">
<h5>nsaph.data_model<a class="headerlink" href="#nsaph-data-model" title="Permalink to this headline"></a></h5>
<p>Implements version 2 of the data modelling toolkit.</p>
<p>Version 1 was focused on loading into the database already
processed data saved as flat files. It inferred data
model from the data files structure and accompanied README
files. The inferred data model is converted to database schema
by generating appropriate DDL.</p>
<p>Version 2 focuses on generating code required to do the
actual processing. The main concept is a knowledge domain, or
just a domain. Domain model is define in a YAML file as
described in the <a class="reference internal" href="doc/Datamodels.html"><span class="doc">documentation</span></a>. The main
module that processes the YAML definition of the domain
is <a class="reference external" href="doc/members/domain.html">domain.py</a>. Another
module, <a class="reference external" href="doc/members/inserter.html">inserter</a>
handles parallel insertion of the data into domain tables.</p>
<p>Auxiliary modules perform various maintenance tasks.
Module <a class="reference external" href="doc/members/index_builder.html">index2</a>
builds indices for a given tables or for all
tables within a domain.
Module <a class="reference external" href="doc/members/utils.html">utils</a>
provides convenience function wrappers and defines
class DataReader that abstracts reading CSV and FST files.
In other words, DataReader provides uniform interface
to reading columnar files in two (potentially more)
different formats.</p>
</section>
<section id="database-connection-wrapper">
<h5>Database Connection Wrapper<a class="headerlink" href="#database-connection-wrapper" title="Permalink to this headline"></a></h5>
<p>Module <a class="reference external" href="doc/members/db.html">db</a> is a PostgreSQL
connection wrapper. It reads connection parameters from
an <code class="docutils literal notranslate"><span class="pre">ini</span></code> file and connects to the database. It can
transparently connect over <em><strong>ssh tunnel</strong></em> when required.</p>
</section>
<section id="nsaph-loader">
<h5>nsaph.loader<a class="headerlink" href="#nsaph-loader" title="Permalink to this headline"></a></h5>
<p>A wrapper around the
<a class="reference internal" href="doc/Datamodels.html"><span class="doc">Universal Data Loader</span></a>.</p>
</section>
<section id="nsaph-requests">
<h5>nsaph.requests<a class="headerlink" href="#nsaph-requests" title="Permalink to this headline"></a></h5>
<p>Package nsaph.requests contains some code that is
intended to be used for fulfilling user requests. Its
development is currently put on hold.</p>
<p>Module <a class="reference external" href="doc/members/hdf5_export.html">hdf5_export</a> exports
result of SQL query as an HDF5 file. The structure of the HDF5 is
described by a YAML request definition.</p>
<p>Module <a class="reference external" href="doc/members/query.html">query</a> generates SQL query
from a YAML request definition.</p>
</section>
<section id="nsaph-util">
<h5>nsaph.util<a class="headerlink" href="#nsaph-util" title="Permalink to this headline"></a></h5>
<p>Package nsaph.util contains:</p>
<ul class="simple">
<li><p>Support for packaging <a class="reference external" href="#resources">resources</a>
in two modules <a class="reference external" href="doc/members/resources.html">resources</a>
and <a class="reference external" href="doc/members/pg_json_dump.html">pg_json_dump</a>. The
latter module imports and exports PostgreSQL (pg) tables
as JSONLines format.</p></li>
<li><p>Module <a class="reference external" href="doc/members/net.html">net</a> contains
one method resolving host to <code class="docutils literal notranslate"><span class="pre">localhost</span></code>. This method is
required by Airflow.</p></li>
<li><p>Module <a class="reference external" href="doc/members/executors.html">executors</a>
implements a<br /><a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor">ThreadPoolExecutor</a>
with a bounded queue. It is used to prevent out of memory (OOM)
errors when processing huge files (to prevent loading
the whole file into memory before dispatching it for processing).</p></li>
</ul>
</section>
<section id="nsaph-tools">
<h5>nsaph.tools<a class="headerlink" href="#nsaph-tools" title="Permalink to this headline"></a></h5>
<p>This package contains code that was written to try to extract
corrupted medicare data for 2015. Ultimately, this attempt
was unsuccessful.</p>
</section>
</section>
</section>
<section id="yaml-files">
<h3>YAML files<a class="headerlink" href="#yaml-files" title="Permalink to this headline"></a></h3>
<p>The majority of files are data model definitions. For now, they
are included in <strong><em>nsaph</em></strong> package because they are used by
different utilities and thus, expected to be stored in
a specific location.</p>
<p>Beside data model files, there are YAML files for:</p>
<ul class="simple">
<li><p>Conda environments, required for NSAPH pipelines. Unless we
will be able to create a single environment that accomodate
all pipelines we will probably deprecate them and move
into corresponding pipeline repositories.</p></li>
<li><p>Sample user requests for future downstream pipelines
that create user workspaces from the database. File
<a class="reference external" href="src/yml/example_request.yaml">example_request.yml</a> is used by
<a class="reference external" href="doc/members/hdf5_export.html">sample request handler</a></p></li>
</ul>
</section>
<section id="resources">
<h3>Resources<a class="headerlink" href="#resources" title="Permalink to this headline"></a></h3>
<p>Resources are organized in the following way:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- ${database schema}/
    - ddl file for ${resource1}
    - content of ${resource1} in JSON Lines format (*.json.gz)
    - ddl file for ${resource2}
    - content of ${resource2} in JSON Lines format (*.json.gz)
</pre></div>
</div>
<p>Resources can be packaged when a
<a class="reference external" href="https://pythonwheels.com/">wheel</a>
is built. Support for packaging resources during development and
after a package is deployed is provided by
<a class="reference external" href="doc/members/resources.html">resources</a> module.</p>
<p>Another module, <a class="reference external" href="doc/members/pg_json_dump.html">pg_json_dump</a>,
provides support for packaging tables as resources in JSONLines
format. This format is used natively by some DBMSs.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="NSAPH Core Data Platform" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="doc/Datamodels.html" class="btn btn-neutral float-right" title="Data Modelling for NSAPH Data Platform" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Harvard University.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>